import checkbox from "./icons/checkbox.png";
import xmark from "./icons/xmark-solid.svg";
import pen from "./icons/pen-to-square.svg";
import { Project, TodoItem } from './todo';


class BaseDialog {
  constructor() {
    this.dialog = document.createElement("dialog");
    this.dialog.classList.add("dialog");

    this.form = document.createElement("form");
    this.form.action = "#";
    this.form.classList.add("form-container");
    this.dialog.appendChild(this.form);


    this.submit = document.createElement("button");
    this.submit.type = "submit";
    this.submit.classList.add("project-submit");
  }

  create() {
    document.body.appendChild(this.dialog);
  }

  close() {
    this.dialog.close();
  }

  showModal() {
    this.dialog.showModal();
  }
}

export class TodoDialog {
  static create() {
    const dialog = document.createElement("dialog");
    dialog.classList.add("dialog");

    const form = document.createElement("form");
    form.action = "#";
    form.classList.add("form-container");

    let fragment = document.createDocumentFragment();

    let label, div;

    ["title", "description"].forEach((field) => {
      let input = document.createElement("input");
      if (field === "title") { input.setAttribute("required", ""); }
      input.type = "text";
      input.classList.add(`form-${field}`);
      input.name = field;
      input.placeholder = field[0].toUpperCase() + field.slice(1);
      fragment.appendChild(input);
    });

    div = document.createElement("div");
    label = document.createElement("label");
    label.setAttribute("for", "due-date");
    label.innerText = "Due date:";
    const date = document.createElement("input");
    date.type = "date";
    date.id = "due-date";
    date.name = "date";
    div.appendChild(label);
    div.appendChild(date);
    fragment.appendChild(div);

    ["priority", "project"].forEach((field) => {
      div = document.createElement("div");
      label = document.createElement("label");
      label.textContent = `${field}: `;
      label.setAttribute("for", `${field}-select`);
      const select = document.createElement("select");
      select.id = `${field}-select`;
      select.name = field;

      let options = ["low", "medium", "high"];
      if (field === "project") {
        let projects = JSON.parse(localStorage.getItem("projects"));
        options = projects.map(project => project.title);
      }
      options.forEach(optionValue => {
        let option = document.createElement("option");
        option.value = optionValue;
        option.text = optionValue;
        select.appendChild(option);
      });
      div.appendChild(label);
      div.appendChild(select);
      fragment.appendChild(div);
    });

    const submit = document.createElement("button");
    submit.type = "submit";
    submit.textContent = "Add todo";
    submit.classList.add("dialog-submit");
    fragment.appendChild(submit);

    form.appendChild(fragment);
    form.addEventListener("submit", formSubmit);
    dialog.appendChild(form);

    return dialog;
  }

  static close() {
    let dialog = document.querySelector(".dialog");
    dialog.close();
  }
}

export class CreateProjectDialog extends BaseDialog {
  constructor() {
    super();

    this.dialog.id = "project-dialog";
    const input = document.createElement("input");
    input.setAttribute("required", "");
    input.type = "text";
    input.classList.add("project-title");
    input.name = "project-title";
    input.placeholder = "Project title";
    this.form.appendChild(input);

    this.submit.textContent = "Add project";
    this.submit.addEventListener("click", this.createProjectSubmit.bind(this));

    this.form.appendChild(this.submit);
  }

  createProjectSubmit(e) {
    e.preventDefault();
    let projectName = this.dialog.querySelector(".project-title").value;

    let projects = JSON.parse(localStorage.getItem("projects")) || [];
    for (let project of projects) {
      if (project.title === projectName) {
        alert("A project with the same title already exists. Please enter a different title.");
        return;
      }
    }
    (new Project(projectName)).pushToStorage();
    this.close();
    this.form.reset();
    updateProjectsUl();
    updateTodoProjectsInput();
  }
}

export class ModifyProjectDialog extends BaseDialog {
  constructor() {
    super();

    this.dialog.id = "modify-project-dialog";
    const input = document.createElement("input");
    input.setAttribute("required", "");
    input.type = "text";
    input.classList.add("modified-project-title");
    input.name = "modified-project-title";
    input.placeholder = "New project title";
    this.form.appendChild(input);

    this.submit.textContent = "Rename project";
    this.submit.addEventListener("click", this.ChangeProjectNameSubmit.bind(this));

    this.form.appendChild(this.submit);
  }

  ChangeProjectNameSubmit(e) {
    e.preventDefault();
    let modifiedProjectName = this.dialog.querySelector(".modified-project-title").value;
    let projects = JSON.parse(localStorage.getItem("projects")) || [];
    for (let project of projects) {
      if (project.title === modifiedProjectName) {
        alert("A project with the same title already exists. Please enter a different title.");
        return;
      }
    }
    // Update project name
    for (let project of projects) {
      if (project.title === this.previousName) {
        project.title = modifiedProjectName;
      }
    }

    localStorage.setItem("projects", JSON.stringify(projects));
    this.close();
    updateProjectsUl();
    updateTodoProjectsInput();
  }
}

const projDial = new CreateProjectDialog();
projDial.create();
const changeProjectDialog = new ModifyProjectDialog();
changeProjectDialog.create();

function formSubmit(event) {
  event.preventDefault();
  let date = new Date(document.querySelector("#due-date").valueAsNumber);
  let todo = new TodoItem(
    document.querySelector(".form-title").value,
    document.querySelector(".form-description").value,
    (date instanceof Date && !isNaN(date)) ? date : null,
    document.querySelector("#priority-select").value,
  );

  let projectTitle = document.getElementById("project-select").value;
  document.getElementById("project-select").addEventListener("change", (e) => {
    projectTitle = document.getElementById("project-select").value;
  });
  try {
    todo.addTodo(projectTitle);
  } catch (error) { // TODO improve
    alert("A todo with the same title already exists in this project. Please enter a different title.");
    return;
  }

  let form = document.querySelector(".form-container");
  form.reset();
  TodoDialog.close();
};


/**
 * Creates a top bar element for a to-do list.
 * @returns {HTMLElement} The top bar element containing an icon and a title.
 */
export function createTopbar() {
  const topbar = document.createElement("div");
  topbar.setAttribute("id", "topbar");

  const icon = new Image();
  icon.src = checkbox;
  topbar.appendChild(icon);

  const h1 = document.createElement("h1");
  h1.appendChild(document.createTextNode("TO DO"));
  topbar.appendChild(h1);

  return topbar;
};

export function createNavbar(todoDialog) {
  const navbar = document.createElement("div");
  navbar.setAttribute("id", "navbar");

  const create = document.createElement("button");
  create.textContent = "Create";
  create.classList.add("todo-create");
  create.addEventListener("click", (e) => {
    e.preventDefault();
    todoDialog.showModal();
  });

  navbar.appendChild(create);

  const primaryUl = document.createElement("ul");
  primaryUl.setAttribute("id", "primary-ul");

  const filters = ["Today", "Upcoming", "Important",];

  filters.forEach((filter) => {
    const li = document.createElement("li");
    li.textContent = filter;
    li.classList.add(filter.toLowerCase());
    primaryUl.appendChild(li);
  });
  navbar.appendChild(primaryUl);

  const projectHeader = document.createElement("h2");
  projectHeader.classList.add("project-header");
  projectHeader.textContent = "Projects: ";
  navbar.appendChild(projectHeader);


  const projectsUl = document.createElement("ul");
  projectsUl.id = "projects-ul";
  projectsUl.addEventListener("click", showProjectTodos);
  navbar.appendChild(projectsUl);

  const createProject = document.createElement("div");
  createProject.classList.add("create-project");
  createProject.textContent = "Create new project";
  createProject.addEventListener("click", (e) => {
    e.preventDefault();
    projDial.showModal(); //project Dialog
  });

  navbar.appendChild(createProject);

  return navbar;
};

function showProjectTodos(e) {
  const mainColumn = document.getElementById("main-column");
  while (mainColumn.firstChild) {
    mainColumn.removeChild(mainColumn.lastChild);
  }

  const projects = JSON.parse(localStorage.getItem("projects"));
  const project = projects.find((p) => e.target.textContent === p.title);
  for (let todo of project.todoList) {
    const div = document.createElement("div");
    const title = document.createElement("h3");
    title.textContent = todo.title;
    const desc = document.createElement("p");
    desc.textContent = todo.description;
    div.appendChild(title);
    div.appendChild(desc);
    mainColumn.appendChild(div);
  };
};


export function updateProjectsUl() {
  const projectsUl = document.querySelector("#projects-ul");
  while (projectsUl.firstChild) {
    projectsUl.removeChild(projectsUl.lastChild);
  };

  const projects = JSON.parse(localStorage.getItem("projects")) || [];
  for (let project of projects) {
    const li = document.createElement("li");
    const title = document.createElement("p");
    const icons = document.createElement("div");
    icons.classList.add("icons");

    const penIcon = document.createElement("img");
    penIcon.classList.add("edit-icon");
    penIcon.src = pen;
    penIcon.addEventListener("click", (e) => {
      e.stopPropagation();
      // save projectName on memory
      changeProjectDialog.previousName = e.target.parentElement.parentElement.firstChild.textContent;

      changeProjectDialog.showModal();
    });
    icons.appendChild(penIcon);

    const xIcon = document.createElement("img");
    xIcon.classList.add("delete-icon");
    xIcon.src = xmark;
    xIcon.addEventListener("click", (e) => {
      e.stopPropagation();
      Project.removeFromStorage(project.title);
      updateProjectsUl();
      updateTodoProjectsInput();
    });
    icons.appendChild(xIcon);

    title.textContent = project.title;
    li.appendChild(title);
    li.appendChild(icons);
    projectsUl.appendChild(li);
  };
};

function updateTodoProjectsInput() {
  const projectSelect = document.querySelector("#project-select");
  while (projectSelect.firstChild) {
    projectSelect.removeChild(projectSelect.lastChild);
  }
  const projects = JSON.parse(localStorage.getItem("projects"));
  if (projects) {
    projects.forEach((project) => {
      const option = document.createElement("option");
      option.textContent = project["title"];
      projectSelect.appendChild(option);
    });
  };
};